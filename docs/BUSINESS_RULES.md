# BUSINESS RULES — Boat Ticket App

## Roles

### Seller (Продавец)
- Продавец может продавать билеты только до `seller_cutoff_minutes`.
- Если `seller_cutoff_minutes = NULL`, ограничений по cutoff нет.
- Продавец не может продавать после cutoff.
- Продавец не может переопределять правила.

### Dispatcher (Диспетчер)
- Диспетчер может продавать билеты до `dispatcher_cutoff_minutes`.
- `dispatcher_cutoff_minutes` всегда `>= seller_cutoff_minutes`.
- Диспетчер может продавать, даже если продавец уже не может.

### Admin
- Управляет шаблонами, лодками, настройками.

---

## Trips / Slots

### Типы рейсов
- `manual` slot — создан вручную.
- `generated` slot — создан из шаблона.

Тип рейса не влияет на правила закрытия: manual и generated должны вести себя одинаково.

---

## Закрытие рейса

Рейс считается закрытым только если текущее серверное время `>= cutoff_time`.

Запрещено закрывать рейс:
- по типу (`generated`/`manual`);
- по отсутствию шаблона;
- по предположениям.

---

## Продажа билетов

- Продажа оформляется как `presale`.
- Продажа всегда привязана к `slotUid`.
- Ошибки должны быть явными и структурированными.

---

## Неделя и Сезон

### Неделя (weekly motivation)
- Используется ISO-неделя `YYYY-Www`.
- Границы недели: понедельник–воскресенье (включительно).
- Неделя может пересекать календарный год.
  Пример: `2026-W01` = `2025-12-29` ... `2026-01-04`.

### Сезон (season motivation, текущее правило)
- По умолчанию и в текущей реализации API сезон для `season_id=YYYY` считается как:
  `YYYY-01-01 ... YYYY-12-31` (обе границы включительно).
- В ответе `GET /api/owner/motivation/season` это отражается как
  `meta.season_rule = "calendar_year_jan01_dec31"`.

### Сезон (Owner Settings Omni: модель поддерживаемой конфигурации)
- Поддерживаемая модель границ сезона: `season_start_mmdd` и `season_end_mmdd` в формате `MM-DD`.
- Год сезона задается выбранным `season_id` (например, `2026`):
  `season_start = 2026-<season_start_mmdd>`, `season_end = 2026-<season_end_mmdd>`.
- Границы `start` и `end` включительные.
- Сезон рассчитывается только внутри одного календарного года (без перехода через Новый год).
- Если настройки не заданы, используется дефолт `01-01 ... 12-31`.

---

## Фонды и Delete с Предоплатой

### Источник истины фондов
- `money_ledger` — единственный источник истины для фондов и финансовых итогов.

### Состав сезонного фонда
- Сезонный фонд (`season_pool_total_ledger`) считается как сумма типов:
  `WITHHOLD_SEASON + SEASON_PREPAY_DELETE`.
- `SEASON_PREPAY_DELETE` — это явный перевод предоплаты в сезонный фонд при удалении с решением `decision=FUND`.

### Dispatcher delete с предоплатой
- Поддерживаемые решения: `decision=REFUND | FUND`.
- Полное удаление заказа (`presale` удалён полностью / удален последний активный билет):
  при `decision=FUND` предоплата переводится в сезонный фонд (`SEASON_PREPAY_DELETE`).
- Частичное удаление (в заказе остаются активные пассажиры):
  предоплата остается в заказе, перевод в сезонный фонд не создается.

---

## Инварианты Мотивации/Фондов

- Инвариант 1 (Weekly): `money_ledger(WITHHOLD_WEEKLY)` ↔ `API.weekly_pool_total_ledger` ↔ `UI.weekly_pool_total_current`.
- Инвариант 2 (Season): `money_ledger(WITHHOLD_SEASON + SEASON_PREPAY_DELETE)` ↔ `API.season_pool_total_ledger` ↔ `UI.season_pool_total_current`.
- Инвариант 3 (Консистентность расчета): `*_pool_total_ledger` должен сходиться с `*_pool_total_daily_sum`; отклонения отражаются в `*_pool_is_consistent=false` и считаются регрессией.
